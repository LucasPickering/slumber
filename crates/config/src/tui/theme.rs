use ratatui_core::style::Color;
use serde::{Deserialize, Serialize};

/// User-configurable visual settings. These are used to generate the full style
/// set.
#[derive(Debug, Serialize, Deserialize)]
#[cfg_attr(test, derive(PartialEq))]
#[cfg_attr(feature = "schema", derive(schemars::JsonSchema))]
#[serde(default, deny_unknown_fields)]
pub struct Theme {
    /// Color for primary content such as the selected pane
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub primary_color: Color,
    // Theoretically we could calculate this based on primary color, but for
    // named or indexed colors, we don't know the exact RGB code since it
    // depends on the user's terminal theme. It's much easier and less
    // fallible to just have the user specify it.
    /// Color for text on top of the primary color. This should contrast with
    /// the primary color well
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub primary_text_color: Color,
    /// Color for secondary accented content
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub secondary_color: Color,
    /// Color representing success (e.g. for 2xx status codes)
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub success_color: Color,
    /// Color representing error (e.g. for 4xx status codes)
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub error_color: Color,
    /// Color for regular text
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub text_color: Color,
    /// Color for the background of the application
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub background_color: Color,
    /// Color for inactive text and components
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub inactive_color: Color,
    /// Color for hint text
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub hint_text_color: Color,
    /// Color for the background of text boxes
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub textbox_background_color: Color,
    /// Color of the background underneath the cursor
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub cursor_background_color: Color,
    /// Color of the text underneath the cursor
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub cursor_text_color: Color,
    /// Color of the background of the gutter text
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub gutter_background_color: Color,
    /// Color of the gutter text
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub gutter_text_color: Color,
    /// Color of the background of alternating table rows
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub alternate_row_background_color: Color,
    /// Color of the text of alternating table rows
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub alternate_row_text_color: Color,
    /// User-configurable visual settings for syntax highlighting
    pub syntax: Syntax,
}

impl Default for Theme {
    fn default() -> Self {
        Self {
            primary_color: Color::Blue,
            secondary_color: Color::Yellow,
            success_color: Color::Green,
            error_color: Color::Red,
            text_color: Color::Reset,
            background_color: Color::Reset,
            primary_text_color: Color::White,
            syntax: Default::default(),
            inactive_color: Color::DarkGray,
            hint_text_color: Color::DarkGray,
            textbox_background_color: Color::DarkGray,
            cursor_background_color: Color::Blue,
            cursor_text_color: Color::DarkGray,
            gutter_background_color: Color::Reset,
            gutter_text_color: Color::DarkGray,
            alternate_row_background_color: Color::White,
            alternate_row_text_color: Color::DarkGray,
        }
    }
}

/// User-configurable visual settings for syntax highlighting.
#[derive(Debug, Serialize, Deserialize)]
#[cfg_attr(test, derive(PartialEq))]
#[cfg_attr(feature = "schema", derive(schemars::JsonSchema))]
#[serde(default, deny_unknown_fields)]
pub struct Syntax {
    /// Color for comments
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub comment_color: Color,
    /// Color for builtins
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub builtin_color: Color,
    /// Color for escape characters
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub escape_color: Color,
    /// Color for numbers
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub number_color: Color,
    /// Color for strings
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub string_color: Color,
    /// Color for special characters
    #[cfg_attr(feature = "schema", schemars(with = "schema::Color"))]
    pub special_color: Color,
}

impl Default for Syntax {
    fn default() -> Self {
        Self {
            comment_color: Color::Gray,
            builtin_color: Color::Blue,
            escape_color: Color::Green,
            number_color: Color::Cyan,
            string_color: Color::LightGreen,
            special_color: Color::Green,
        }
    }
}

/// Helpers for JSON Schema generation
#[cfg(feature = "schema")]
mod schema {
    /// ANSI color code
    ///
    /// This type accepts input beyond the enumerated values, but for simplicity
    /// this type only declares the named colors. The other available options
    /// are very rarely used and make the schema harder to read.
    ///
    /// For a full list of allowed types, see
    /// [the ratatui docs](https://docs.rs/ratatui/0.29.0/ratatui/style/enum.Color.html#impl-FromStr-for-Color).
    #[cfg(feature = "schema")]
    #[derive(schemars::JsonSchema)]
    #[schemars(rename = "Color", schema_with = "color_schema")]
    // This type is just a vessel for a JSON Schema. We replace ratatui's Color
    // with this in the schema
    pub struct Color;

    #[cfg(feature = "schema")]
    fn color_schema(_: &mut schemars::SchemaGenerator) -> schemars::Schema {
        schemars::json_schema!({
            "type": "string",
            "enum": [
                "black",
                "red",
                "green",
                "yellow",
                "blue",
                "magenta",
                "cyan",
                "gray",
                "darkgray",
                "lightred",
                "lightgreen",
                "lightyellow",
                "lightblue",
                "lightmagenta",
                "lightcyan",
                "white",
                "reset",
            ]
        })
    }
}
